import{r,R as te,j as e}from"./query-vendor-Du5i0pT7.js";import{H as U,E as ae,a as se}from"./ErrorMessage-Cc20MXJj.js";import{L as q}from"./index-DC7foqXv.js";import"./react-vendor-DJG_os-6.js";import"./charts-vendor-CIWdG-YD.js";const re=()=>{const[$,w]=r.useState(null),[R,f]=r.useState(!1),[z,t]=r.useState(null),g=r.useRef(null);r.useEffect(()=>{if(typeof Window<"u"&&"Worker"in window)try{g.current=new Worker(new URL("/assets/rollingStatsWorker-DQJaitvW.js",import.meta.url),{type:"module"}),g.current.onmessage=n=>{n.data.type==="ROLLING_STATS_RESULT"?(w(n.data.data),f(!1),t(null)):n.data.type==="ERROR"&&(t(n.data.error),f(!1))},g.current.onerror=n=>{t(`Worker error: ${n.message}`),f(!1)}}catch(n){console.warn("Failed to create worker, falling back to main thread:",n),t("Worker not available, using main thread")}return()=>{g.current&&(g.current.terminate(),g.current=null)}},[]);const I=r.useCallback((n,j)=>{if(!n||!n.length)return{avg:[],plus2:[],minus2:[],pctLinesAbove:[],pctLinesBelow:[],pctPercents:[.1,.2,.3,.4,.5,.6]};const i=[.1,.2,.3,.4,.5,.6],H=365.25*24*3600*1e3,b=[],D=[],L=[],M=i.map(()=>[]),x=i.map(()=>[]);for(let p=0;p<n.length;++p){const[c]=n[p],Y=c-j*H;let a=0,B=p;for(;a<B;){const d=Math.floor((a+B)/2);n[d][0]>=Y?B=d:a=d+1}const v=n.slice(a,p+1).map(([d,u])=>u);if(v.length>1){const d=v.reduce((y,m)=>y+m,0)/v.length,u=v.reduce((y,m)=>y+(m-d)**2,0)/v.length,_=Math.sqrt(u);b.push([c,d]),D.push([c,d+2*_]),L.push([c,d-2*_]),i.forEach((y,m)=>{M[m].push([c,d*(1+y)]),x[m].push([c,d*(1-y)])})}else b.push([c,null]),D.push([c,null]),L.push([c,null]),i.forEach((d,u)=>{M[u].push([c,null]),x[u].push([c,null])})}return{avg:b,plus2:D,minus2:L,pctLinesAbove:M,pctLinesBelow:x,pctPercents:i}},[]),T=r.useCallback((n,j)=>{if(f(!0),t(null),g.current)g.current.postMessage({type:"CALCULATE_ROLLING_STATS",data:{peData:n,nYears:j}});else try{const i=I(n,j);w(i),f(!1)}catch(i){t(i instanceof Error?i.message:"Calculation failed"),f(!1)}},[I]);return{rollingStats:$,isLoading:R,error:z,calculateStats:T}},J=["#1abc9c","#3498db","#9b59b6","#e67e22","#e74c3c","#f39c12"],Q=["ShortDash","ShortDot","ShortDashDot","Dash","Dot","DashDot"],le=[.1,.2,.3,.4,.5,.6],ne=te.memo(({indexId:$,displayName:w,color:R="#2E86AB",autoRefresh:f=!1,refreshInterval:z=60*60*1e3})=>{const[t,g]=r.useState(null),[I,T]=r.useState(!0),[n,j]=r.useState(null),[i,H]=r.useState(20),[b,D]=r.useState(!0),[L,M]=r.useState(!1),[x,p]=r.useState(!1),[c,Y]=r.useState({min:void 0,max:void 0}),{rollingStats:a,isLoading:B,calculateStats:v}=re(),d=r.useCallback(async s=>{const l=await fetch(`/api/market_pe/${s}.json`);if(!l.ok)throw new Error(`Failed to fetch ${s} PE data: ${l.status}`);return l.json()},[]),u=r.useCallback(async(s=!0)=>{try{s&&T(!0),p(!0),j(null);const l=await d($);g(l)}catch(l){j(l instanceof Error?l.message:"Failed to load PE data")}finally{T(!1),p(!1)}},[d,$]);r.useEffect(()=>{u()},[u]),r.useEffect(()=>{if(!f)return;const s=setInterval(()=>{u(!1)},z);return()=>{clearInterval(s)}},[f,z,u]),r.useEffect(()=>{t?.data&&t.data.length>0&&v(t.data,i)},[t?.data,i,v]);const _=r.useMemo(()=>{if(!a)return{pctColors:J,pctDashStyles:Q,pctPercents:le,pctLinesAbove:[],pctLinesBelow:[],visiblePctIdxs:[],xAxisMin:void 0,xAxisMax:void 0};const s=a.pctPercents||[],l=a.pctLinesAbove||[],S=a.pctLinesBelow||[];let W=[];if(t?.data&&t.data.length&&s.length){const k=t.data.length-1,O=t.data[k][1],A=a.avg[k]?.[1];if(A!=null){const P=l.map(o=>o[k]?.[1]),h=S.map(o=>o[k]?.[1]),F=[...P.map((o,N)=>({idx:N,val:o,type:"above"})),...h.map((o,N)=>({idx:N,val:o,type:"below"}))].filter(o=>o.val!==null&&o.val!==void 0);F.sort((o,N)=>Math.abs((o.val??0)-O)-Math.abs((N.val??0)-O)),W=F.slice(0,2).map(o=>o.type==="above"?o.idx:o.idx+s.length)}}let E,C;if(t?.data&&t.data.length){C=t.data[t.data.length-1][0];const k=6*30.44*24*3600*1e3;E=C-k,E<t.data[0][0]&&(E=t.data[0][0])}return{pctColors:J,pctDashStyles:Q,pctPercents:s,pctLinesAbove:l,pctLinesBelow:S,visiblePctIdxs:W,xAxisMin:E,xAxisMax:C}},[a,i,t?.data,b]),y=r.useMemo(()=>{const{pctColors:s,pctDashStyles:l,pctPercents:S,pctLinesAbove:W,pctLinesBelow:E,visiblePctIdxs:C,xAxisMin:k,xAxisMax:O}=_,A=[{name:w,data:t?.data||[],color:"#F92672",type:"line",zIndex:3,lineWidth:2,marker:{enabled:!1,states:{hover:{enabled:!0,radius:6,lineWidth:2,lineColor:R}}}}];return a&&(A.push({name:`${i}Y Avg`,data:a.avg,color:"#A6E22E",dashStyle:"Dash",type:"line",zIndex:2,lineWidth:2,marker:{enabled:!1}}),L&&A.push({name:"+2 Std",data:a.plus2,color:"#FD971F",dashStyle:"Dot",type:"line",zIndex:1,lineWidth:3,marker:{enabled:!1}},{name:"-2 Std",data:a.minus2,color:"#FD971F",dashStyle:"Dot",type:"line",zIndex:1,lineWidth:3,marker:{enabled:!1}})),b&&(S.forEach((P,h)=>{A.push({name:`+${Math.round(P*100)}% Avg`,data:W[h],color:s[h],dashStyle:l[h],type:"line",zIndex:0,lineWidth:3,visible:C.includes(h),marker:{enabled:!1}})}),S.forEach((P,h)=>{A.push({name:`-${Math.round(P*100)}% Avg`,data:E[h],color:s[h],dashStyle:l[h],type:"line",zIndex:0,lineWidth:3,visible:C.includes(h+S.length),marker:{enabled:!1}})})),{chart:{type:"line",height:650,backgroundColor:"rgba(0, 0, 0, 0.3)",zoomType:"x",panning:{enabled:!0,type:"x"},style:{fontFamily:"inherit"},events:{load:function(){}},plotBackgroundColor:"rgba(0, 0, 0, 0.2)",plotBorderWidth:0,plotShadow:!1,spacing:[5,5,5,5],reflow:!0},title:{text:""},subtitle:{text:""},xAxis:{type:"datetime",labels:{format:"{value:%Y-%m-%d}",style:{fontSize:"14px",color:"#D1D5DB",fontWeight:"500"}},min:k,max:O,gridLineWidth:2,gridLineColor:"rgba(107, 114, 128, 0.4)",lineColor:"rgba(156, 163, 175, 0.6)",tickColor:"rgba(156, 163, 175, 0.6)",tickWidth:2,tickLength:6,crosshair:{color:"rgba(96, 165, 250, 0.7)",width:2,dashStyle:"shortdot"}},yAxis:{title:{text:"PE Ratio",style:{fontSize:"16px",fontWeight:"700",color:"#E5E7EB"}},labels:{format:"{value:.1f}",style:{fontSize:"14px",color:"#D1D5DB",fontWeight:"500"}},gridLineWidth:2,gridLineColor:"rgba(107, 114, 128, 0.4)",lineColor:"rgba(156, 163, 175, 0.6)",tickColor:"rgba(156, 163, 175, 0.6)",tickWidth:2,tickLength:6,crosshair:{color:"rgba(96, 165, 250, 0.7)",width:2,dashStyle:"shortdot"}},tooltip:{shared:!0,backgroundColor:"rgba(17, 24, 39, 0.98)",borderWidth:0,shadow:!0,borderRadius:8,style:{fontSize:"13px",color:"#ffffff"},formatter:function(){let h=`<div style="padding: 4px 0;"><b style="color: #60A5FA; font-size: 14px;">${U.dateFormat("%Y-%m-%d",this.x)}</b></div><br/>`;return this.points?.forEach(F=>{const o=F.series.name,N=F.y?.toFixed(2),Z=o===w,ee=o.includes("Avg")&&!o.includes("%");let V="#9ca3af",G="#ffffff";Z?(V="#60A5FA",G="#60A5FA"):ee&&(V="#A78BFA",G="#A78BFA"),h+=`<span style="color:${F.color}; font-size: 16px;">●</span> <span style="color: ${V}; font-weight: 500;">${o}</span>: <span style="color: ${G}; font-weight: bold;">${N}</span><br/>`}),h}},legend:{enabled:!0,align:"center",verticalAlign:"bottom",layout:"horizontal",itemStyle:{fontSize:"14px",color:"#F3F4F6",fontWeight:"600"},itemHoverStyle:{color:"#60A5FA"},symbolHeight:12,symbolWidth:24,symbolRadius:3,backgroundColor:"rgba(0, 0, 0, 0.9)",borderWidth:1,borderColor:"rgba(75, 85, 99, 0.6)",borderRadius:8,shadow:!0,itemDistance:20,padding:12,width:"100%",height:50,itemWidth:150,useHTML:!1,floating:!1,x:0,y:0},plotOptions:{line:{marker:{enabled:!1},lineWidth:2},series:{animation:{duration:1e3}}},navigator:{enabled:!0,height:40,margin:10,outlineWidth:0,outlineColor:"transparent",handles:{backgroundColor:"rgba(96, 165, 250, 0.8)",borderColor:"rgba(96, 165, 250, 1)",lineColor:"rgba(96, 165, 250, 0.5)",rifleColor:"rgba(96, 165, 250, 0.8)"},xAxis:{gridLineColor:"rgba(0, 0, 0, 0.4)",lineColor:"rgba(75, 85, 99, 0.6)",tickColor:"rgba(75, 85, 99, 0.4)",labels:{style:{color:"#9ca3af",fontSize:"10px"}}}},scrollbar:{enabled:!0,barBackgroundColor:"rgba(75, 85, 99, 0.5)",barBorderColor:"rgba(75, 85, 99, 0.8)",buttonBackgroundColor:"rgba(55, 65, 81, 0.8)",buttonBorderColor:"rgba(75, 85, 99, 0.8)",buttonArrowColor:"#9ca3af",rifleColor:"rgba(96, 165, 250, 0.8)",trackBackgroundColor:"rgba(31, 41, 55, 0.3)",trackBorderColor:"rgba(75, 85, 99, 0.3)"},rangeSelector:{enabled:!0,selected:0,inputEnabled:!1,buttonTheme:{fill:"rgba(0, 0, 0, 0.9)",stroke:"rgba(75, 85, 99, 0.6)",r:8,states:{hover:{fill:"rgba(31, 41, 55, 0.9)",style:{color:"#ffffff"}},select:{fill:"rgba(96, 165, 250, 0.8)",style:{color:"#ffffff",fontWeight:"bold"}}},style:{color:"#9ca3af",fontSize:"12px",fontWeight:"500"}},buttons:[{type:"month",count:6,text:"6m"},{type:"year",count:1,text:"1y"},{type:"year",count:3,text:"3y"},{type:"year",count:5,text:"5y"},{type:"all",text:"All"}]},responsive:{rules:[{condition:{maxWidth:768},chartOptions:{legend:{enabled:!1},chart:{height:400}}}]},series:A,credits:{enabled:!1},exporting:{enabled:!0,buttons:{contextButton:{symbol:"menu",symbolX:12,symbolY:10,symbolSize:14,symbolStrokeWidth:2,symbolStroke:"#9ca3af",symbolFill:"rgba(31, 41, 55, 0.8)",menuItems:["downloadPNG","downloadPDF","downloadCSV"],theme:{fill:"rgba(31, 41, 55, 0.95)",stroke:"rgba(75, 85, 99, 0.5)",states:{hover:{fill:"rgba(55, 65, 81, 0.95)",style:{color:"#ffffff"}}}}}}}}},[w,R,i,a,L,b,_,t?.data]),m=r.useCallback(()=>{u(!1)},[u]),X=r.useCallback(s=>{H(Math.max(1,Math.min(100,s)))},[]),K=r.useCallback(s=>{s&&s.xAxis&&s.xAxis[0]&&(Y({min:s.xAxis[0].min,max:s.xAxis[0].max}),s.xAxis[0].update({events:{afterSetExtremes:function(l){Y({min:l.target.min,max:l.target.max})}}}))},[]);return I?e.jsx("div",{className:"chart-container",children:e.jsx(q,{text:"Loading PE data..."})}):B&&!a?e.jsx("div",{className:"chart-container",children:e.jsx(q,{text:"Calculating statistics..."})}):n?e.jsxs("div",{className:"chart-container",children:[e.jsx(ae,{message:`Error: ${n}`}),e.jsx("div",{className:"mt-4 text-center",children:e.jsx("button",{onClick:m,className:"btn-primary",disabled:x,children:x?"Refreshing...":"Retry"})})]}):e.jsxs("div",{className:"chart-container",children:[e.jsxs("div",{className:"chart-header",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"chart-title",style:{color:R},children:w}),e.jsx("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:e.jsx("button",{onClick:m,disabled:x,className:"btn-secondary text-xs",title:"Refresh data",children:x?e.jsx("div",{className:"loading-spinner w-4 h-4"}):"↻"})})]}),e.jsx("div",{className:"chart-controls mt-2",children:e.jsxs("div",{className:"flex items-center gap-6 flex-wrap",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium",children:["N-year:",e.jsx("input",{type:"number",min:1,max:100,value:i,onChange:s=>X(Number(s.target.value)),className:"input-field w-16 text-center","aria-label":"N-year window"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:L,onChange:s=>M(s.target.checked)}),"Std Dev Lines"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:b,onChange:s=>D(s.target.checked)}),"Percentage Lines"]})]})})]}),t&&e.jsx("div",{className:"chart-stats py-1 px-3",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"chart-stat",children:[e.jsx("div",{className:"chart-stat-label",children:"Current PE"}),e.jsx("div",{className:"chart-stat-value",children:t.stats.current_pe.toFixed(2)})]}),e.jsxs("div",{className:"chart-stat",children:[e.jsxs("div",{className:"chart-stat-label",children:[i,"-Year Avg"]}),e.jsx("div",{className:"chart-stat-value",children:a?.avg&&a.avg.length>0&&a.avg[a.avg.length-1]?.[1]?a.avg[a.avg.length-1][1]?.toFixed(2):t.stats.avg_20y.toFixed(2)})]}),e.jsxs("div",{className:"chart-stat",children:[e.jsx("div",{className:"chart-stat-label",children:"Range"}),e.jsx("div",{className:"chart-stat-value text-sm",children:(()=>{const s=t.data.filter(([l])=>!c.min||!c.max?!0:l>=c.min&&l<=c.max);if(s.length>0){const l=s.map(([E,C])=>C),S=Math.min(...l),W=Math.max(...l);return`${S.toFixed(2)} - ${W.toFixed(2)}`}return`${t.stats.min_pe.toFixed(2)} - ${t.stats.max_pe.toFixed(2)}`})()})]}),e.jsxs("div",{className:"chart-stat",children:[e.jsxs("div",{className:"chart-stat-label",children:["vs ",i,"Y Avg"]}),e.jsxs("div",{className:`chart-stat-value ${t.stats.current_pe>(a?.avg&&a.avg.length>0&&a.avg[a.avg.length-1]?.[1]||t.stats.avg_20y)?"text-red-400":"text-green-400"}`,children:[((t.stats.current_pe/(a?.avg&&a.avg.length>0&&a.avg[a.avg.length-1]?.[1]||t.stats.avg_20y)-1)*100).toFixed(1),"%"]})]})]})}),e.jsx("div",{className:"mt-1",children:e.jsx(se,{highcharts:U,options:y,callback:K})})]})});ne.displayName="MarketPeChart";export{ne as default};
