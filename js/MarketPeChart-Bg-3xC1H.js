import{r as l,R as te,j as e}from"./query-vendor-Du5i0pT7.js";import{d as ae,H as U,L as q,a as se}from"./index-kt27ZEuh.js";import{E as re}from"./ErrorMessage-B58T-2Vz.js";import"./react-vendor-DJG_os-6.js";import"./charts-vendor-CIWdG-YD.js";import"./utils-vendor-BnbtjNgs.js";const le=()=>{const[I,E]=l.useState(null),[F,f]=l.useState(!1),[z,t]=l.useState(null),g=l.useRef(null);l.useEffect(()=>{if(typeof Window<"u"&&"Worker"in window)try{g.current=new Worker(new URL("/assets/rollingStatsWorker-DQJaitvW.js",import.meta.url),{type:"module"}),g.current.onmessage=n=>{n.data.type==="ROLLING_STATS_RESULT"?(E(n.data.data),f(!1),t(null)):n.data.type==="ERROR"&&(t(n.data.error),f(!1))},g.current.onerror=n=>{t(`Worker error: ${n.message}`),f(!1)}}catch(n){console.warn("Failed to create worker, falling back to main thread:",n),t("Worker not available, using main thread")}return()=>{g.current&&(g.current.terminate(),g.current=null)}},[]);const $=l.useCallback((n,x)=>{if(!n||!n.length)return{avg:[],plus2:[],minus2:[],pctLinesAbove:[],pctLinesBelow:[],pctPercents:[.1,.2,.3,.4,.5,.6]};const i=[.1,.2,.3,.4,.5,.6],H=365.25*24*3600*1e3,b=[],M=[],L=[],D=i.map(()=>[]),p=i.map(()=>[]);for(let v=0;v<n.length;++v){const[c]=n[v],Y=c-x*H;let a=0,B=v;for(;a<B;){const d=Math.floor((a+B)/2);n[d][0]>=Y?B=d:a=d+1}const y=n.slice(a,v+1).map(([d,u])=>u);if(y.length>1){const d=y.reduce((S,m)=>S+m,0)/y.length,u=y.reduce((S,m)=>S+(m-d)**2,0)/y.length,_=Math.sqrt(u);b.push([c,d]),M.push([c,d+2*_]),L.push([c,d-2*_]),i.forEach((S,m)=>{D[m].push([c,d*(1+S)]),p[m].push([c,d*(1-S)])})}else b.push([c,null]),M.push([c,null]),L.push([c,null]),i.forEach((d,u)=>{D[u].push([c,null]),p[u].push([c,null])})}return{avg:b,plus2:M,minus2:L,pctLinesAbove:D,pctLinesBelow:p,pctPercents:i}},[]),T=l.useCallback((n,x)=>{if(f(!0),t(null),g.current)g.current.postMessage({type:"CALCULATE_ROLLING_STATS",data:{peData:n,nYears:x}});else try{const i=$(n,x);E(i),f(!1)}catch(i){t(i instanceof Error?i.message:"Calculation failed"),f(!1)}},[$]);return{rollingStats:I,isLoading:F,error:z,calculateStats:T}},J=["#1abc9c","#3498db","#9b59b6","#e67e22","#e74c3c","#f39c12"],Q=["ShortDash","ShortDot","ShortDashDot","Dash","Dot","DashDot"],ne=[.1,.2,.3,.4,.5,.6],oe=te.memo(({indexId:I,displayName:E,color:F="#2E86AB",autoRefresh:f=!1,refreshInterval:z=60*60*1e3})=>{const[t,g]=l.useState(null),[$,T]=l.useState(!0),[n,x]=l.useState(null),[i,H]=l.useState(20),[b,M]=l.useState(!0),[L,D]=l.useState(!1),[p,v]=l.useState(!1),[c,Y]=l.useState({min:void 0,max:void 0}),{rollingStats:a,isLoading:B,calculateStats:y}=le(),d=l.useCallback(async s=>{const r=await ae.getMarketPE(s);if(!r)throw new Error(`Failed to fetch ${s} PE data: No data available`);return r},[]),u=l.useCallback(async(s=!0)=>{try{s&&T(!0),v(!0),x(null);const r=await d(I);console.log("MarketPeChart: Received PE data:",r),r&&r.stats&&r.stats.current_pe!==void 0?g(r):(console.error("MarketPeChart: Invalid PE data structure:",r),x("Invalid data structure received from API"))}catch(r){console.error("MarketPeChart: Error loading PE data:",r),x(r instanceof Error?r.message:"Failed to load PE data")}finally{T(!1),v(!1)}},[d,I]);l.useEffect(()=>{u()},[u]),l.useEffect(()=>{if(!f)return;const s=setInterval(()=>{u(!1)},z);return()=>{clearInterval(s)}},[f,z,u]),l.useEffect(()=>{t?.data&&t.data.length>0&&y(t.data,i)},[t?.data,i,y]);const _=l.useMemo(()=>{if(!a)return{pctColors:J,pctDashStyles:Q,pctPercents:ne,pctLinesAbove:[],pctLinesBelow:[],visiblePctIdxs:[],xAxisMin:void 0,xAxisMax:void 0};const s=a.pctPercents||[],r=a.pctLinesAbove||[],C=a.pctLinesBelow||[];let P=[];if(t?.data&&t.data.length&&s.length){const A=t.data.length-1,O=t.data[A][1],w=a.avg[A]?.[1];if(w!=null){const W=r.map(o=>o[A]?.[1]),h=C.map(o=>o[A]?.[1]),R=[...W.map((o,N)=>({idx:N,val:o,type:"above"})),...h.map((o,N)=>({idx:N,val:o,type:"below"}))].filter(o=>o.val!==null&&o.val!==void 0);R.sort((o,N)=>Math.abs((o.val??0)-O)-Math.abs((N.val??0)-O)),P=R.slice(0,2).map(o=>o.type==="above"?o.idx:o.idx+s.length)}}let j,k;if(t?.data&&t.data.length){k=t.data[t.data.length-1][0];const A=6*30.44*24*3600*1e3;j=k-A,j<t.data[0][0]&&(j=t.data[0][0])}return{pctColors:J,pctDashStyles:Q,pctPercents:s,pctLinesAbove:r,pctLinesBelow:C,visiblePctIdxs:P,xAxisMin:j,xAxisMax:k}},[a,i,t?.data,b]),S=l.useMemo(()=>{const{pctColors:s,pctDashStyles:r,pctPercents:C,pctLinesAbove:P,pctLinesBelow:j,visiblePctIdxs:k,xAxisMin:A,xAxisMax:O}=_,w=[{name:E,data:t?.data||[],color:"#F92672",type:"line",zIndex:3,lineWidth:2,marker:{enabled:!1,states:{hover:{enabled:!0,radius:6,lineWidth:2,lineColor:F}}}}];return a&&(w.push({name:`${i}Y Avg`,data:a.avg,color:"#A6E22E",dashStyle:"Dash",type:"line",zIndex:2,lineWidth:2,marker:{enabled:!1}}),L&&w.push({name:"+2 Std",data:a.plus2,color:"#FD971F",dashStyle:"Dot",type:"line",zIndex:1,lineWidth:3,marker:{enabled:!1}},{name:"-2 Std",data:a.minus2,color:"#FD971F",dashStyle:"Dot",type:"line",zIndex:1,lineWidth:3,marker:{enabled:!1}})),b&&(C.forEach((W,h)=>{w.push({name:`+${Math.round(W*100)}% Avg`,data:P[h],color:s[h],dashStyle:r[h],type:"line",zIndex:0,lineWidth:3,visible:k.includes(h),marker:{enabled:!1}})}),C.forEach((W,h)=>{w.push({name:`-${Math.round(W*100)}% Avg`,data:j[h],color:s[h],dashStyle:r[h],type:"line",zIndex:0,lineWidth:3,visible:k.includes(h+C.length),marker:{enabled:!1}})})),{chart:{type:"line",height:650,backgroundColor:"rgba(0, 0, 0, 0.3)",zoomType:"x",panning:{enabled:!0,type:"x"},style:{fontFamily:"inherit"},events:{load:function(){}},plotBackgroundColor:"rgba(0, 0, 0, 0.2)",plotBorderWidth:0,plotShadow:!1,spacing:[5,5,5,5],reflow:!0},title:{text:""},subtitle:{text:""},xAxis:{type:"datetime",labels:{format:"{value:%Y-%m-%d}",style:{fontSize:"14px",color:"#D1D5DB",fontWeight:"500"}},min:A,max:O,gridLineWidth:2,gridLineColor:"rgba(107, 114, 128, 0.4)",lineColor:"rgba(156, 163, 175, 0.6)",tickColor:"rgba(156, 163, 175, 0.6)",tickWidth:2,tickLength:6,crosshair:{color:"rgba(96, 165, 250, 0.7)",width:2,dashStyle:"shortdot"}},yAxis:{title:{text:"PE Ratio",style:{fontSize:"16px",fontWeight:"700",color:"#E5E7EB"}},labels:{format:"{value:.1f}",style:{fontSize:"14px",color:"#D1D5DB",fontWeight:"500"}},gridLineWidth:2,gridLineColor:"rgba(107, 114, 128, 0.4)",lineColor:"rgba(156, 163, 175, 0.6)",tickColor:"rgba(156, 163, 175, 0.6)",tickWidth:2,tickLength:6,crosshair:{color:"rgba(96, 165, 250, 0.7)",width:2,dashStyle:"shortdot"}},tooltip:{shared:!0,backgroundColor:"rgba(17, 24, 39, 0.98)",borderWidth:0,shadow:!0,borderRadius:8,style:{fontSize:"13px",color:"#ffffff"},formatter:function(){let h=`<div style="padding: 4px 0;"><b style="color: #60A5FA; font-size: 14px;">${U.dateFormat("%Y-%m-%d",this.x)}</b></div><br/>`;return this.points?.forEach(R=>{const o=R.series.name,N=R.y?.toFixed(2),Z=o===E,ee=o.includes("Avg")&&!o.includes("%");let V="#9ca3af",G="#ffffff";Z?(V="#60A5FA",G="#60A5FA"):ee&&(V="#A78BFA",G="#A78BFA"),h+=`<span style="color:${R.color}; font-size: 16px;">●</span> <span style="color: ${V}; font-weight: 500;">${o}</span>: <span style="color: ${G}; font-weight: bold;">${N}</span><br/>`}),h}},legend:{enabled:!0,align:"center",verticalAlign:"bottom",layout:"horizontal",itemStyle:{fontSize:"14px",color:"#F3F4F6",fontWeight:"600"},itemHoverStyle:{color:"#60A5FA"},symbolHeight:12,symbolWidth:24,symbolRadius:3,backgroundColor:"rgba(0, 0, 0, 0.9)",borderWidth:1,borderColor:"rgba(75, 85, 99, 0.6)",borderRadius:8,shadow:!0,itemDistance:20,padding:12,width:"100%",height:50,itemWidth:150,useHTML:!1,floating:!1,x:0,y:0},plotOptions:{line:{marker:{enabled:!1},lineWidth:2},series:{animation:{duration:1e3}}},navigator:{enabled:!0,height:40,margin:10,outlineWidth:0,outlineColor:"transparent",handles:{backgroundColor:"rgba(96, 165, 250, 0.8)",borderColor:"rgba(96, 165, 250, 1)",lineColor:"rgba(96, 165, 250, 0.5)",rifleColor:"rgba(96, 165, 250, 0.8)"},xAxis:{gridLineColor:"rgba(0, 0, 0, 0.4)",lineColor:"rgba(75, 85, 99, 0.6)",tickColor:"rgba(75, 85, 99, 0.4)",labels:{style:{color:"#9ca3af",fontSize:"10px"}}}},scrollbar:{enabled:!0,barBackgroundColor:"rgba(75, 85, 99, 0.5)",barBorderColor:"rgba(75, 85, 99, 0.8)",buttonBackgroundColor:"rgba(55, 65, 81, 0.8)",buttonBorderColor:"rgba(75, 85, 99, 0.8)",buttonArrowColor:"#9ca3af",rifleColor:"rgba(96, 165, 250, 0.8)",trackBackgroundColor:"rgba(31, 41, 55, 0.3)",trackBorderColor:"rgba(75, 85, 99, 0.3)"},rangeSelector:{enabled:!0,selected:0,inputEnabled:!1,buttonTheme:{fill:"rgba(0, 0, 0, 0.9)",stroke:"rgba(75, 85, 99, 0.6)",r:8,states:{hover:{fill:"rgba(31, 41, 55, 0.9)",style:{color:"#ffffff"}},select:{fill:"rgba(96, 165, 250, 0.8)",style:{color:"#ffffff",fontWeight:"bold"}}},style:{color:"#9ca3af",fontSize:"12px",fontWeight:"500"}},buttons:[{type:"month",count:6,text:"6m"},{type:"year",count:1,text:"1y"},{type:"year",count:3,text:"3y"},{type:"year",count:5,text:"5y"},{type:"all",text:"All"}]},responsive:{rules:[{condition:{maxWidth:768},chartOptions:{legend:{enabled:!1},chart:{height:400}}}]},series:w,credits:{enabled:!1},exporting:{enabled:!0,buttons:{contextButton:{symbol:"menu",symbolX:12,symbolY:10,symbolSize:14,symbolStrokeWidth:2,symbolStroke:"#9ca3af",symbolFill:"rgba(31, 41, 55, 0.8)",menuItems:["downloadPNG","downloadPDF","downloadCSV"],theme:{fill:"rgba(31, 41, 55, 0.95)",stroke:"rgba(75, 85, 99, 0.5)",states:{hover:{fill:"rgba(55, 65, 81, 0.95)",style:{color:"#ffffff"}}}}}}}}},[E,F,i,a,L,b,_,t?.data]),m=l.useCallback(()=>{u(!1)},[u]),X=l.useCallback(s=>{H(Math.max(1,Math.min(100,s)))},[]),K=l.useCallback(s=>{s&&s.xAxis&&s.xAxis[0]&&(Y({min:s.xAxis[0].min,max:s.xAxis[0].max}),s.xAxis[0].update({events:{afterSetExtremes:function(r){Y({min:r.target.min,max:r.target.max})}}}))},[]);return $?e.jsx("div",{className:"chart-container",children:e.jsx(q,{text:"Loading PE data..."})}):B&&!a?e.jsx("div",{className:"chart-container",children:e.jsx(q,{text:"Calculating statistics..."})}):n?e.jsxs("div",{className:"chart-container",children:[e.jsx(re,{message:`Error: ${n}`}),e.jsx("div",{className:"mt-4 text-center",children:e.jsx("button",{onClick:m,className:"btn-primary",disabled:p,children:p?"Refreshing...":"Retry"})})]}):e.jsxs("div",{className:"chart-container",children:[e.jsx("div",{className:"chart-header py-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"chart-title text-lg",style:{color:F},children:E}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium text-text-primary",children:["N-year:",e.jsx("input",{type:"number",min:1,max:100,value:i,onChange:s=>X(Number(s.target.value)),className:"input-field w-16 text-center","aria-label":"N-year window"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium cursor-pointer text-text-primary",children:[e.jsx("input",{type:"checkbox",checked:L,onChange:s=>D(s.target.checked)}),"Std Dev Lines"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm font-medium cursor-pointer text-text-primary",children:[e.jsx("input",{type:"checkbox",checked:b,onChange:s=>M(s.target.checked)}),"Percentage Lines"]}),e.jsx("button",{onClick:m,disabled:p,className:"btn-secondary text-xs",title:"Refresh data",children:p?e.jsx("div",{className:"loading-spinner w-4 h-4"}):"↻"})]})]})}),t&&e.jsx("div",{className:"chart-stats py-0.5",children:e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-1",children:[e.jsxs("div",{className:"chart-stat",children:[e.jsx("div",{className:"chart-stat-label text-xs leading-tight",children:"Current PE"}),e.jsx("div",{className:"chart-stat-value text-sm leading-tight",children:t.stats.current_pe.toFixed(2)})]}),e.jsxs("div",{className:"chart-stat",children:[e.jsxs("div",{className:"chart-stat-label text-xs leading-tight",children:[i,"-Year Avg"]}),e.jsx("div",{className:"chart-stat-value text-sm leading-tight",children:a?.avg&&a.avg.length>0&&a.avg[a.avg.length-1]?.[1]?a.avg[a.avg.length-1][1]?.toFixed(2):t.stats.avg_20y.toFixed(2)})]}),e.jsxs("div",{className:"chart-stat",children:[e.jsx("div",{className:"chart-stat-label text-xs leading-tight",children:"Range"}),e.jsx("div",{className:"chart-stat-value text-xs leading-tight",children:(()=>{const s=t.data.filter(([r])=>!c.min||!c.max?!0:r>=c.min&&r<=c.max);if(s.length>0){const r=s.map(([j,k])=>k),C=Math.min(...r),P=Math.max(...r);return`${C.toFixed(2)} - ${P.toFixed(2)}`}return`${t.stats.min_pe.toFixed(2)} - ${t.stats.max_pe.toFixed(2)}`})()})]}),e.jsxs("div",{className:"chart-stat",children:[e.jsxs("div",{className:"chart-stat-label text-xs leading-tight",children:["vs ",i,"Y Avg"]}),e.jsxs("div",{className:`chart-stat-value text-sm leading-tight ${t.stats.current_pe>(a?.avg&&a.avg.length>0&&a.avg[a.avg.length-1]?.[1]||t.stats.avg_20y)?"text-danger-400":"text-success-400"}`,children:[((t.stats.current_pe/(a?.avg&&a.avg.length>0&&a.avg[a.avg.length-1]?.[1]||t.stats.avg_20y)-1)*100).toFixed(1),"%"]})]})]})}),e.jsx("div",{className:"mt-1",children:e.jsx(se,{highcharts:U,options:S,callback:K})})]})});oe.displayName="MarketPeChart";export{oe as default};
